var languages=new Array(),fetchedTitles=new Array(),done=4,ok=200,homeUrl="http://www.einthusan.com/",queryPath="index.php?lang=",newMoviesCnt,langsChecked,isDataReady=false,LANGUAGE_REQUEST_CONST="languageRequest",MOVIES_REQUEST_CONST="moviesRequest",RESET_NEW_FLAGS="resetNewFlags";FLAGS_RESET="flagsReset",REFRESH_INTERVAL=3*60*60*1000;initiate();function initiate(){sendXMLRequest(homeUrl,LANGUAGE_REQUEST_CONST,null);setTimeout(initiate,REFRESH_INTERVAL)}function getMovieTitlesForLanguage(a){sendXMLRequest(homeUrl+queryPath+a.toLowerCase(),MOVIES_REQUEST_CONST,a)}function capitaliseFirstLetter(a){return a.charAt(0).toUpperCase()+a.slice(1)}function sendXMLRequest(c,b,d,a){var e=new XMLHttpRequest();e.open("GET",c,true);e.setRequestHeader("Content-Type","application/x-www-form-urlencoded");e.onreadystatechange=getResponseHandler(e,b,d,handleXMLRequestResponse);e.send()}function handleXMLRequestResponse(f,j,g){if(f==LANGUAGE_REQUEST_CONST){var h=document.implementation.createHTMLDocument("languages"),b;h.documentElement.innerHTML=g;b=h.getElementsByTagName("li");languages=[];for(i=0;i<b.length;i++){langName=b[i].firstChild.innerHTML;languages.push(langName)}fetchedTitles.length=languages.length;newMoviesCnt=new Array();newMoviesCnt.length=languages.length;langsChecked=new Array();langsChecked.length=languages.length;for(i=0;i<languages.length;i++){langsChecked[i]=0;newMoviesCnt[i]=0;getMovieTitlesForLanguage(languages[i])}setTimeout(fireNotification,1000)}else{if(f==MOVIES_REQUEST_CONST){var d=languages.indexOf(capitaliseFirstLetter(j)),a,e,c;h=document.implementation.createHTMLDocument("movies");h.documentElement.innerHTML=g;a=new Array();e=h.getElementsByClassName("movie-title");c=h.getElementsByClassName("movie-cover-wrapper");for(i=0;i<e.length;i++){a.push(new MovieObject(e[i].innerHTML.split(" - ")[0],c[i].firstChild.getAttribute("src"),c[i].getAttribute("href")))}fetchedTitles[d]=a;updateNumberOfNewMovies(j,a)}}}function getResponseHandler(d,b,c,a){return function(){if(d.readyState==done&&d.status==ok){if(a){a(b,c,d.responseText)}}}}function breakCookieString(c){var a,b;if(c){a=new Array();b=c.split("--");for(i=0;i<b.length;i++){a.push(b[i])}}return a}function getCookie(c){var b=new Object(),a;b.url=homeUrl;b.name=c.toLowerCase()+"Movies";chrome.cookies.get(b,function(d){a=breakCookieString(d.value)});return a}function updateNumberOfNewMovies(b,e){var c=null,a=new Object(),d=languages.indexOf(b);a.url=homeUrl;a.name=b.toLowerCase()+"Movies";chrome.cookies.get(a,function(f){if(f){c=breakCookieString(f.value)}if(!c){newMoviesCnt[d]+=e.length;for(i=0;i<e.length;i++){e[i].isNew=true}}else{for(i=0;i<e.length;i++){var g=e[i].movieTitle;if(c.indexOf(g)<0){newMoviesCnt[languages.indexOf(b)]++;e[i].isNew=true}}}langsChecked[d]=1})}function fireNotification(){if(sumUpArray(langsChecked)==languages.length){isDataReady=true;setBadge()}else{setTimeout(fireNotification,1000)}}function sumUpArray(a){var b=0;for(i=0;i<a.length;i++){b+=a[i]}return b}function MovieObject(d,a,b){var c=new Object();c.movieTitle=d;c.movieCover=a;c.watchURL=b;c.isNew=false;return c}function resetNewFlags(c){var a=languages.indexOf(c),b=fetchedTitles[a];newMoviesCnt[a]=0;for(i=0;i<b.length;i++){b[i].isNew=false}setBadge()}function setBadge(){var a=sumUpArray(newMoviesCnt);if(a>0){chrome.browserAction.setBadgeText({text:a.toString()});chrome.browserAction.setBadgeBackgroundColor({color:[248,148,6,200]})}else{chrome.browserAction.setBadgeText({text:"".toString()});chrome.browserAction.setBadgeBackgroundColor({color:[128,0,0,0]})}}chrome.extension.onRequest.addListener(function(c,b,a){if(c.messageType==RESET_NEW_FLAGS){if(c.language){resetNewFlags(c.language);a({messageType:FLAGS_RESET,language:c.language})}}});